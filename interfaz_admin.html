<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Panel de administración</title>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --container-w: 980px;       /* MISMO ancho que tu contenido */
    --container-pad: 20px;
    --container-bl: 4px;

    --banner-h: 64px;
    --banner-bg: #e6e9ee;
    --banner-bg-hover: #d7dbe3;

    --blue:#5c6bc0; --blue-h:#3f51b5;
    --green:#66bb6a; --red:#ef5350;
    --ink:#233247;
  }

  *{box-sizing:border-box}
  body{
    font-family:'Open Sans',sans-serif;
    background:#eee; color:#333;
    margin:0;
    padding:20px;
    /* Deja espacio para el banner fijo */
    padding-top: calc(var(--banner-h) + 20px);
  }

  /* ===== Banner del ancho de la página (no del navegador) ===== */
  .app-banner{position:fixed; top:0; left:0; right:0; height:var(--banner-h); z-index:999}
  .banner-shell{max-width: calc(var(--container-w) + var(--container-pad)*2 + var(--container-bl));
                margin:0 auto; padding:0 0;}
  .banner-box{
    height:100%;
    background:var(--banner-bg);
    border-radius:10px;
    border-bottom:1px solid rgba(0,0,0,.06);
    display:flex; align-items:center;
    transition:.2s;
    padding:0 12px;
  }
  .banner-box:hover{background:var(--banner-bg-hover)}
  .banner-inner{display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px; width:100%}
  .banner-title{justify-self:center; font-weight:700; color:var(--ink)}
  .banner-logo{justify-self:end}
  .banner-logo img{width:52px;height:auto}
  .back-button{justify-self:start; display:inline-block; text-decoration:none; font-size:14px; color:var(--blue);
               padding:8px 12px; border:1px solid var(--blue); border-radius:6px; transition:.2s}
  .back-button:hover{background:var(--blue); color:#fff}

  /* ===== Página ===== */
  .container{
    max-width:var(--container-w);
    margin:0 auto;
    background:#fff;
    border-radius:10px;
    padding:var(--container-pad);
    border-left:var(--container-bl) solid var(--blue);
    box-shadow:0 4px 8px rgba(0,0,0,.05)
  }
  h1{margin:0 0 18px; text-align:center}

  /* KPIs */
  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:18px}
  .kpi{background:#f8f9ff; border:1px solid #e5e7f5; border-radius:10px; padding:16px}
  .kpi .val{font-size:30px; font-weight:700; color:#000}
  .kpi .lab{margin-top:6px; color:#555}

  /* Comentarios */
  .box{margin-top:16px}
  .subttl{font-weight:700; color:#000; margin:6px 0 10px}
  .dist{margin:8px 0}
  .bar{height:8px;background:#e9edf7;border-radius:6px;overflow:hidden;margin:6px 0}
  .bar>i{display:block;height:100%;width:0;background:var(--blue);border-radius:6px}
  .legend{font-size:12px;color:#666}
  .wrap-flex{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .chart{width:220px;height:220px;position:relative;margin:0 auto}
  .pie-legend{text-align:center;margin-top:6px;font-size:14px}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
  .dot-green{background:#66bb6a}.dot-red{background:#ef5350}
  .filters{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin:10px 0}
  .filters .destino{margin-left:auto}

  .cmt{border:1px solid #ececec;border-radius:10px;padding:12px 14px;margin:8px 0;
       display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
  .cmt-head{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .stars{color:#f5a623}
  .tag{font-size:12px;padding:2px 8px;border-radius:14px}
  .tag.pos{background:#e9f7ef;color:#1b5e20}
  .tag.neu{background:#eef1f6;color:#445}
  .tag.neg{background:#ffe4e4;color:#b00020}
  .muted{color:#666;font-size:12px}
  .btn{border:none;border-radius:8px;padding:10px 14px;cursor:pointer;color:#fff;background:var(--blue)}
  .btn:hover{background:var(--blue-h)}

  .legal-outside{
    margin:18px auto 24px; padding:10px 12px;
    max-width: calc(var(--container-w) + var(--container-pad)*2 + var(--container-bl));
    text-align:center; color:#666; font-size:14px; line-height:1.35
  }

  @media(max-width:920px){.kpis{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.kpis{grid-template-columns:1fr}}
</style>
</head>
<body>
  <!-- Banner con ancho de página -->
  <header class="app-banner">
    <div class="banner-shell">
      <div class="banner-box">
        <div class="banner-inner">
          <a href="#" class="back-button" onclick="history.back();return false;">&larr; Volver</a>
          <div class="banner-title">Panel de administración</div>
          <a href="interfaz_inicio_s.html" class="banner-logo"><img src="LogoCitasYa.png" alt="Citas Ya"></a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <h1>Panel de administración</h1>

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi"><div id="kpiBiz" class="val">0</div><div class="lab">Barberías activas</div></div>
      <div class="kpi"><div id="kpiStaff" class="val">0</div><div class="lab">Barberos activos</div></div>
      <div class="kpi"><div id="kpiAvg" class="val">0.0</div><div class="lab">Citas/día (promedio 7d)</div></div>
      <div class="kpi"><div id="kpiCancel" class="val">0%</div><div class="lab">Tasa de cancelación</div></div>
    </section>

    <!-- Resumen de comentarios -->
    <section class="box">
      <h2 class="subttl">Resumen de comentarios</h2>

      <div class="wrap-flex">
        <div style="flex:1 1 480px;min-width:280px">
          <div class="legend">Promedio</div>
          <div style="font-size:28px;font-weight:700"><span id="avgScore">0.0</span> / 5.0 ★</div>

          <div class="dist">
            <div>5★<div class="bar"><i id="b5"></i></div><div class="legend" id="p5">0%</div></div>
            <div>4★<div class="bar"><i id="b4"></i></div><div class="legend" id="p4">0%</div></div>
            <div>3★<div class="bar"><i id="b3"></i></div><div class="legend" id="p3">0%</div></div>
            <div>2★<div class="bar"><i id="b2"></i></div><div class="legend" id="p2">0%</div></div>
            <div>1★<div class="bar"><i id="b1"></i></div><div class="legend" id="p1">0%</div></div>
          </div>
        </div>

        <div style="flex:0 0 260px">
          <div class="chart"><canvas id="pie" width="220" height="220"></canvas></div>
          <div class="pie-legend">
            <div><span class="dot dot-green"></span> <strong>Sí:</strong> <span id="yesPct">0%</span></div>
            <div style="margin-top:4px"><span class="dot dot-red"></span> <strong>No:</strong> <span id="noPct">0%</span></div>
          </div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="filters">
        <label><input type="radio" name="f" value="all" checked> Todos</label>
        <label><input type="radio" name="f" value="positivo"> Positivos</label>
        <label><input type="radio" name="f" value="neutro"> Neutros</label>
        <label><input type="radio" name="f" value="negativo"> Negativos</label>
        <select id="destino" class="destino">
          <option value="all">Todos los destinos</option>
          <option value="site">Solo página</option>
          <option value="barberia">Solo barberías</option>
        </select>
      </div>

      <div id="cmtList"></div>
    </section>
  </div>

  <!-- Legal fuera de la página -->
  <div class="legal-outside">
    Todos los derechos reservados © 2025<br>
    Citas Ya S.A.S - Nit 810.000.000-0
  </div>

<script>
/* ===== Claves de almacenamiento ===== */
const LS_BIZ='cy_businesses';
const LS_COM='cy_comments';
const LS_BOOK='cy_bookings';       // respaldo si faltan appointments
const LS_APPT='cy_appointments';   // fuente principal

/* ===== Util ===== */
const byId=id=>document.getElementById(id);
const safeJSON=(k,def=[])=>{try{return JSON.parse(localStorage.getItem(k))||def}catch(_){return def}};
const sum=a=>a.reduce((s,n)=>s+n,0);
const fmtPct=n=>(isNaN(n)?0:n).toFixed(0)+'%';

/* Fecha de una cita sin importar el formato almacenado */
function apptISODate(a){
  // preferencia: a.date (yyyy-mm-dd)
  if(a && a.date){ return a.date.slice(0,10); }
  // start / datetime / dateTime (ISO)
  if(a && a.start){ return String(a.start).slice(0,10); }
  if(a && a.datetime){ return String(a.datetime).slice(0,10); }
  if(a && a.dateTime){ return String(a.dateTime).slice(0,10); }
  return null;
}
/* Estado normalizado: scheduled/booked = programada; cancelled/canceled = cancelada */
function apptStatus(a){
  const s=(a?.status||'').toLowerCase();
  if(s==='cancelled' || s==='canceled') return 'cancelled';
  if(s==='booked' || s==='scheduled')   return 'scheduled';
  return s||'scheduled';
}

/* ===== KPIs ===== */
function renderKPIs(){
  const businesses=safeJSON(LS_BIZ,[]);
  byId('kpiBiz').textContent=businesses.length;
  byId('kpiStaff').textContent=businesses.reduce((acc,b)=>(acc+(b.staff||[]).length),0);

  // Fuente principal
  let appts=safeJSON(LS_APPT,[]);
  // Respaldo: convertir bookings -> appointments scheduled
  if(!appts.length){
    const books=safeJSON(LS_BOOK,[]);
    appts=books.map(b=>({date:(b.date||''), start:b.start, status:'scheduled'}));
  }

  // Normalizar y filtrar las que tienen fecha válida
  const norm=appts.map(a=>({date:apptISODate(a), status:apptStatus(a)}))
                  .filter(a=>!!a.date);

  // Promedio últimos 7 días
  const today=new Date(); today.setHours(0,0,0,0);
  const last7=[];
  for(let i=6;i>=0;i--){
    const d=new Date(today); d.setDate(today.getDate()-i);
    const iso=d.toISOString().slice(0,10);
    const c=norm.filter(a=>a.status==='scheduled' && a.date===iso).length;
    last7.push(c);
  }
  byId('kpiAvg').textContent=(sum(last7)/7).toFixed(1);

  // Tasa de cancelación
  const total=norm.length;
  const cancelled=norm.filter(a=>a.status==='cancelled').length;
  byId('kpiCancel').textContent= total? fmtPct((cancelled/total)*100) : '0%';
}

/* ===== Comentarios ===== */
function distBars(total,counts){
  [5,4,3,2,1].forEach(n=>{
    const pct=total?(counts[n]||0)*100/total:0;
    byId('b'+n).style.width=pct+'%';
    byId('p'+n).textContent=fmtPct(pct);
  });
}
function drawPie(yesPct){
  const c=byId('pie'),ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  const cx=c.width/2,cy=c.height/2,r=90,s=-Math.PI/2,a=(yesPct/100)*Math.PI*2;
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.fillStyle='#66bb6a';ctx.arc(cx,cy,r,s,s+a);ctx.fill();
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.fillStyle='#ef5350';ctx.arc(cx,cy,r,s+a,s+Math.PI*2);ctx.fill();
}
function renderComments(){
  const all=safeJSON(LS_COM,[]);
  const total=all.length, avg= total? sum(all.map(c=>c.rating||0))/total : 0;
  byId('avgScore').textContent=avg.toFixed(1);

  const counts={1:0,2:0,3:0,4:0,5:0}; all.forEach(c=>{counts[c.rating||0]=(counts[c.rating||0]||0)+1});
  distBars(total,counts);

  const yes=all.filter(c=>c.recommend===true).length;
  const yesPct= total? (yes*100/total):0; const noPct=100-yesPct;
  byId('yesPct').textContent=fmtPct(yesPct); byId('noPct').textContent=fmtPct(noPct);
  drawPie(yesPct);

  const radios=document.querySelectorAll('input[name="f"]');
  radios.forEach(r=> r.onchange=()=> list(all));
  byId('destino').onchange=()=> list(all);
  list(all);
}
function list(all){
  const type=document.querySelector('input[name="f"]:checked').value; // all|positivo|neutro|negativo
  const dest=byId('destino').value;                                   // all|site|barberia
  let arr=all.slice();
  if(type!=='all') arr=arr.filter(c=>c.sentiment===type);
  if(dest!=='all'){
    if(dest==='site') arr=arr.filter(c=>c.target?.type==='pagina');
    if(dest==='barberia') arr=arr.filter(c=>c.target?.type==='barberia');
  }
  const wrap=byId('cmtList'); wrap.innerHTML='';
  if(!arr.length){ wrap.innerHTML='<div class="muted">No hay comentarios para este filtro.</div>'; return; }

  arr.forEach(c=>{
    const row=document.createElement('div'); row.className='cmt';
    const left=document.createElement('div'); const right=document.createElement('div');

    const who=(c.author && c.author.trim())? c.author.trim() : 'Anonymous';
    const destTxt=c.target?.type==='barberia' ? (' · Barbería: '+(c.target?.name||'')) : ' · Página';
    const when=new Date(c.createdAt||Date.now()).toLocaleString();

    const line1=document.createElement('div');
    line1.innerHTML=`<strong>${who}</strong><span class="muted"> · ${when}${destTxt}</span>`;

    const line2=document.createElement('div');
    const stars='★'.repeat(Math.max(0,c.rating||0));
    const tagCls=c.sentiment==='positivo'?'pos':(c.sentiment==='negativo'?'neg':'neu');
    line2.innerHTML=`<span class="stars">${stars}</span> <span class="tag ${tagCls}">${c.sentiment}</span>`;

    left.appendChild(line1); left.appendChild(line2);

    if((c.text||'').trim()){
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Ver comentario';
      const p=document.createElement('div'); p.className='muted'; p.style.display='none'; p.style.marginTop='8px'; p.textContent=c.text.trim();
      btn.onclick=()=>{ p.style.display = p.style.display==='none' ? 'block':'none'; };
      right.appendChild(btn); left.appendChild(p);
    }

    row.appendChild(left); row.appendChild(right); wrap.appendChild(row);
  });
}

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  renderKPIs();
  renderComments();
});
</script>
</body>
</html>
