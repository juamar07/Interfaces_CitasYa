<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cancelar o Re-agendar cita</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --container-w: 920px;
      --container-pad: 20px;
      --container-bl: 4px;

      --banner-h: 64px;
      --page-sidepad: 16px;
      --banner-bg: #e6e9ee;
      --banner-bg-hover: #d7dbe3;
    }

    body{
      font-family: 'Open Sans', sans-serif;
      background:#eeeeee;
      margin:0;
      padding:20px;
      color:#333;
      padding-top: calc(var(--banner-h) + 8px);
    }
    .container{
      max-width: var(--container-w);
      margin: 0 auto;
      padding: var(--container-pad);
      background:#fff;
      border-radius:10px;
      box-shadow:0 4px 8px rgba(0,0,0,.05);
      border-left: var(--container-bl) solid #5c6bc0;
    }

    h1{ text-align:center; margin:0 0 14px; font-weight:700; color:#000; }
    h2{ margin:18px 0 10px; font-weight:700; color:#000; }
    h3{ margin:12px 0 8px; color:#233247; }
    label{ display:block; margin:8px 0 4px; color:#003366; }
    .muted{ color:#666; font-size:14px; }

    input[type="text"], input[type="date"], select, textarea{
      width:100%; padding:10px; border:2px solid #ddd; border-radius:6px; font-size:16px;
      transition: border-color .2s; box-sizing:border-box;
    }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:#7da2a9; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .two-btns{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .wide75{
      width: 75%;
      margin: 12px auto;
    }
    @media (max-width: 768px){
      .wide75{ width: 100%; }
    }

    .btn{
      display:block; border:none; border-radius:6px; padding:12px 18px; color:#fff; font-weight:700; cursor:pointer;
      transition: background-color .2s, transform .2s; width:100%; margin:10px 0; font-size:16px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn-green{ background:#66bb6a; } .btn-green:hover{ background:#43a047; }
    .btn-blue{  background:#5c6bc0; } .btn-blue:hover{  background:#3f51b5; }
    .btn-red{   background:#ef5350; } .btn-red:hover{   background:#e53935; }

    .card{
      border:1px dashed #bdbdbd; border-radius:8px; padding:12px; background:#fafafa; margin:8px 0 12px;
    }

    textarea{ min-height:150px; resize:vertical; }

    /* Banner */
    .app-banner{ position:fixed; top:0; left:0; right:0; height:var(--banner-h); z-index:9999; background:transparent; }
    .app-banner .banner-box{
      height:100%;
      width:min(calc(var(--container-w) + var(--container-pad)*2 + var(--container-bl)), calc(100% - var(--page-sidepad)*2));
      margin:0 auto; background:var(--banner-bg); border-bottom:1px solid rgba(0,0,0,.06); border-radius:10px;
      display:flex; align-items:center; transition:background-color .2s ease;
    }
    .app-banner .banner-box:hover,.app-banner .banner-box:focus-within{ background:var(--banner-bg-hover); }
    .app-banner .banner-inner{ display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:8px; width:100%; padding:0 12px;}
    .banner-back{ justify-self:start; }
    .banner-title{ justify-self:center; font-weight:700; color:#233247; }
    .banner-logo{ justify-self:end; display:inline-flex; align-items:center; }
    .banner-logo img{ width:52px; height:auto; display:block; }
    .back-button{
      display:inline-block; text-decoration:none; font-size:14px; color:#5c6bc0;
      padding:8px 12px; border:1px solid #5c6bc0; border-radius:6px; transition: background-color .2s, color .2s;
    }
    .back-button:hover{ background:#5c6bc0; color:#fff; }

    /* Footer legal fuera del card */
    .legal-outside{
      margin: 18px auto 24px; padding:10px 12px;
      max-width: calc(var(--container-w) + var(--container-pad)*2 + var(--container-bl));
      text-align:center; color:#666; font-size:14px; line-height:1.35;
    }

    @media (max-width:768px){
      .row, .two-btns{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- ===== Banner ===== -->
  <header class="app-banner" role="banner">
    <div class="banner-box">
      <div class="banner-inner">
        <a href="#" class="back-button banner-back" onclick="history.back(); return false;">&larr; Volver</a>
        <div class="banner-title">Cancelar o Re-agendar</div>
        <a href="interfaz_inicio_s.html" class="banner-logo" aria-label="Ir al inicio">
          <img src="LogoCitasYa.png" alt="Citas Ya">
        </a>
      </div>
    </div>
  </header>

  <div class="container">
    <h1>Cancelar o Re-agendar una cita</h1>

    <!-- Acción + Asistente -->
    <section class="row">
      <div>
        <label for="accion">Acción</label>
        <select id="accion">
          <option value="cancelar">Cancelar</option>
          <option value="reagendar">Re-agendar</option>
        </select>
      </div>
      <div>
        <label for="attendee">Nombre del asistente</label>
        <input type="text" id="attendee" list="attendeesList" placeholder="Ej: Juan Martín Betancur">
        <datalist id="attendeesList"></datalist>
        <small class="muted">Escribe el nombre tal como lo registraste; la búsqueda ignora mayúsculas y acentos.</small>
      </div>
    </section>

    <!-- Citas encontradas -->
    <section id="citasSection" style="display:none;">
      <h2>Selecciona la cita</h2>
      <div id="citasList" class="card"></div>
    </section>

    <!-- Bloque cancelar -->
    <section id="cancelBlock" style="display:none;">
      <h2>Resumen de la cita</h2>
      <textarea id="cancelSummary" readonly></textarea>
      <div class="two-btns">
        <button id="btnCancelar" class="btn btn-red">Confirmar cancelación</button>
        <button id="btnClear" class="btn btn-blue">Limpiar</button>
      </div>
    </section>

    <!-- Bloque re-agendar -->
    <section id="reBlock" style="display:none;">
      <h2>Re-agendar la cita</h2>
      <div class="card">
        <h3 style="margin-top:0;">Detalles (puedes cambiar servicio/barbero/fecha/hora)</h3>
        <div class="row">
          <div>
            <label>Barbería</label>
            <input type="text" id="bizName" readonly>
          </div>
          <div>
            <label for="svc">Servicio</label>
            <select id="svc"></select>
            <small class="muted" id="svcDur">Duración: —</small>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="staff">Barbero</label>
            <select id="staff"></select>
          </div>
          <div class="row" style="grid-template-columns: 1fr 1fr; gap:12px;">
            <div>
              <label for="date">Fecha</label>
              <input type="date" id="date">
            </div>
            <div>
              <label for="timeSel">Hora</label>
              <select id="timeSel" disabled><option value="">— Selecciona fecha —</option></select>
              <small class="muted" id="timeHelp"></small>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Cita anterior</h3>
          <textarea id="oldSummary" readonly></textarea>
        </div>
        <div>
          <h3>Nueva cita</h3>
          <textarea id="newSummary" readonly></textarea>
        </div>
      </div>

      <div class="two-btns wide75">
        <button id="btnReagendar" class="btn btn-green">Confirmar re-agendación</button>
        <button id="btnClear2" class="btn btn-blue">Limpiar</button>
      </div>
    </section>
  </div>

  <!-- Legal -->
  <div class="legal-outside">
    Todos los derechos reservados © 2025<br>
    Citas Ya S.A.S - Nit 810.000.000-0
  </div>

<script>
/* ===== Storage & utils ===== */
const LS_BOOKINGS='cy_bookings';
const LS_BIZ='cy_businesses';
const LS_SCH='cy_schedules';
const LS_APPT='cy_appointments';

const $=s=>document.querySelector(s);
const plain=s=>(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();

const getBookings = ()=>{ try{return JSON.parse(localStorage.getItem(LS_BOOKINGS))||[]}catch(_){return[]} };
const saveBookings= arr => localStorage.setItem(LS_BOOKINGS, JSON.stringify(arr));
const getBusinesses=()=>{ try{return JSON.parse(localStorage.getItem(LS_BIZ))||[]}catch(_){return[]} };
const getSchedules =()=>{ try{return JSON.parse(localStorage.getItem(LS_SCH))||[]}catch(_){return[]} };
const getAppts    =()=>{ try{return JSON.parse(localStorage.getItem(LS_APPT))||[]}catch(_){return[]} };
const saveAppts   =arr => localStorage.setItem(LS_APPT, JSON.stringify(arr));

const addMinutes=(t,m)=>{const[h,mm]=t.split(':').map(Number);const d=new Date(2000,0,1,h,mm,0);d.setMinutes(d.getMinutes()+m);return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');};
const toMin =t=>{const[h,m]=t.split(':').map(Number);return h*60+m};
const overlap=(aS,aE,bS,bE)=> toMin(aS)<toMin(bE) && toMin(bS)<toMin(aE);

/* ===== Controles ===== */
const accion   = $('#accion');
const attendee = $('#attendee'); const attendeesList=$('#attendeesList');

const citasSection=$('#citasSection'); const citasList=$('#citasList');

const cancelBlock=$('#cancelBlock'); const cancelSummary=$('#cancelSummary'); const btnCancelar=$('#btnCancelar'); const btnClear=$('#btnClear');

const reBlock=$('#reBlock'); const bizName=$('#bizName'); const svc=$('#svc'); const svcDur=$('#svcDur');
const staff=$('#staff'); const dateEl=$('#date'); const timeSel=$('#timeSel'); const timeHelp=$('#timeHelp');
const oldSummary=$('#oldSummary'); const newSummary=$('#newSummary');
const btnReagendar=$('#btnReagendar'); const btnClear2=$('#btnClear2');

let foundBookings=[];  // lista de citas del asistente
let selectedBooking=null;

/* ===== Horarios (para reagendar) ===== */
function getScheduleBlockFor(businessSlug, staffName, dateISO){
  const blocks=getSchedules().filter(b =>
    (b.businessSlug||'')===businessSlug && (b.staffName||'')===staffName &&
    dateISO>=b.dateStart && dateISO<=b.dateEnd
  );
  if(!blocks.length) return null;
  blocks.sort((a,b)=> (a.createdAt||'')<(b.createdAt||'')?-1:1);
  return blocks[blocks.length-1];
}
function windowsFromDay(d){
  if(!d||!d.work||!d.start||!d.end||d.start>=d.end) return [];
  const base=[[d.start,d.end]];
  if(d.lunchStart&&d.lunchEnd&&d.lunchStart<d.lunchEnd){
    const out=[]; base.forEach(([a,b])=>{
      if(d.lunchStart>a) out.push([a,Math.min(b,d.lunchStart)]);
      if(d.lunchEnd<b)   out.push([Math.max(a,d.lunchEnd),b]);
    });
    return out.filter(([a,b])=>a<b);
  }
  return base;
}
function slotsFromWindows(wins,dur){
  const s=[]; for(const [a,b] of wins){ let t=a; while(toMin(t)+dur<=toMin(b)){ s.push(t); t=addMinutes(t,10);} } return s;
}
function removeBookedSlots(slots, businessSlug, staffName, dateISO, duration, ignoreId){
  const books=getBookings().filter(b=> b.businessSlug===businessSlug && b.staffName===staffName && b.date===dateISO && b.id!==ignoreId);
  return slots.filter(t=>{
    const e=addMinutes(t,duration);
    return !books.some(b=> overlap(t,e,b.start,b.end));
  });
}

/* ===== Búsqueda por asistente ===== */
function fillAttendees(){
  attendeesList.innerHTML='';
  const set=new Set(getBookings().map(b=>b.attendee));
  [...set].sort().forEach(n=>{ const op=document.createElement('option'); op.value=n; attendeesList.appendChild(op); });
}
document.addEventListener('DOMContentLoaded', ()=>{ fillAttendees(); accion.dispatchEvent(new Event('change')); });

accion.addEventListener('change', ()=>{
  citasSection.style.display='none'; citasList.innerHTML='';
  cancelBlock.style.display='none'; reBlock.style.display='none';
  selectedBooking=null;
});

attendee.addEventListener('input', ()=>{ clearTimeout(attendee._t); attendee._t=setTimeout(searchBookings,250); });
attendee.addEventListener('change', searchBookings);

function searchBookings(){
  const name=plain(attendee.value);
  citasList.innerHTML='';
  if(!name){ citasSection.style.display='none'; return; }

  foundBookings=getBookings().filter(b=> plain(b.attendee)===name);
  if(!foundBookings.length){
    citasSection.style.display='block';
    citasList.innerHTML='<div class="muted">No se encontraron citas para ese asistente.</div>';
    cancelBlock.style.display='none'; reBlock.style.display='none'; selectedBooking=null;
    return;
  }
  renderBookings();
}
function renderBookings(){
  citasSection.style.display='block'; citasList.innerHTML='';
  foundBookings.forEach((b,idx)=>{
    const row=document.createElement('div');
    row.style.display='grid'; row.style.gridTemplateColumns='auto 1fr auto'; row.style.gap='10px'; row.style.alignItems='center'; row.style.padding='6px 0'; row.style.borderBottom='1px solid #eee';

    const r=document.createElement('input'); r.type='radio'; r.name='bk'; r.id='bk_'+idx; r.value=b.id;
    if(idx===0) r.checked=true;

    const lab=document.createElement('label'); lab.setAttribute('for','bk_'+idx);
    lab.innerHTML=`<strong>${b.businessName}</strong> · ${b.serviceName} · ${b.staffName}<br><span class="muted">${b.date} ${b.start}–${b.end}</span>`;

    const sel=document.createElement('button'); sel.className='btn btn-blue'; sel.style.width='auto'; sel.style.margin='0'; sel.textContent='Seleccionar';
    sel.addEventListener('click',()=> selectBooking(b.id));

    row.appendChild(r); row.appendChild(lab); row.appendChild(sel);
    citasList.appendChild(row);
  });
  selectBooking(foundBookings[0].id);
}
function selectBooking(id){
  selectedBooking=foundBookings.find(b=>b.id===id);
  if(!selectedBooking) return;

  if(accion.value==='cancelar'){
    cancelBlock.style.display='block'; reBlock.style.display='none';
    cancelSummary.value =
      `Asistente: ${selectedBooking.attendee}\n`+
      `Establecimiento: ${selectedBooking.businessName}\n`+
      `Servicio: ${selectedBooking.serviceName} (${selectedBooking.durationMins} min)\n`+
      `Barbero: ${selectedBooking.staffName}\n`+
      `Fecha: ${selectedBooking.date}\n`+
      `Hora: ${selectedBooking.start} - ${selectedBooking.end}\n\n`+
      `¿Deseas cancelar esta cita?`;
  }else{
    cancelBlock.style.display='none'; reBlock.style.display='block';
    preloadReagenda(selectedBooking);
  }
}

/* ===== Cancelar ===== */
btnCancelar.addEventListener('click', ()=>{
  if(!selectedBooking){ alert('Selecciona una cita.'); return; }
  if(!confirm('¿Confirmas que deseas cancelar la cita?')) return;

  // quitar de bookings
  saveBookings(getBookings().filter(b=>b.id!==selectedBooking.id));

  // actualizar métricas cy_appointments
  const appts=getAppts();
  const idx=appts.findIndex(a=> a.id===selectedBooking.id ||
    (a.attendee===selectedBooking.attendee && a.businessSlug===selectedBooking.businessSlug &&
     a.staffName===selectedBooking.staffName && a.date===selectedBooking.date &&
     a.timeStart===selectedBooking.start));
  if(idx>-1){ appts[idx].status='cancelled'; appts[idx].updatedAt=new Date().toISOString(); saveAppts(appts); }

  alert('Cita cancelada. La franja quedó disponible.');
  resetAll();
});
btnClear.addEventListener('click', resetAll);
function resetAll(){
  attendee.value=''; citasSection.style.display='none'; citasList.innerHTML='';
  cancelBlock.style.display='none'; reBlock.style.display='none'; selectedBooking=null; fillAttendees();
}

/* ===== Re-agendar ===== */
function preloadReagenda(bk){
  bizName.value=bk.businessName;
  const biz=getBusinesses().find(x=>(x.slug||'')===(bk.businessSlug||''));

  svc.innerHTML=''; staff.innerHTML='';
  if(!biz){
    svc.innerHTML='<option>(no disponible)</option>'; staff.innerHTML='<option>(no disponible)</option>'; return;
  }
  // servicios
  (biz.services||[]).sort((a,b)=>a.order-b.order).forEach(s=>{
    const op=document.createElement('option'); op.value=s.id; op.textContent=`${s.name} (${s.durationMins} min)`; op.dataset.duration=s.durationMins;
    if(String(s.id)===String(bk.serviceId)) op.selected=true;
    svc.appendChild(op);
  });
  updateStaffOptions(biz, String(bk.serviceId));

  dateEl.value=bk.date;
  buildTimeOptions();

  oldSummary.value =
    `Asistente: ${bk.attendee}\n`+
    `Establecimiento: ${bk.businessName}\n`+
    `Servicio: ${bk.serviceName} (${bk.durationMins} min)\n`+
    `Barbero: ${bk.staffName}\n`+
    `Fecha: ${bk.date}\n`+
    `Hora: ${bk.start} - ${bk.end}`;
  updateNewSummary();
}
function updateStaffOptions(biz, serviceId){
  staff.innerHTML='';
  (biz.staff||[]).forEach(p=>{
    if(p && p.name && p.offers && p.offers[serviceId]){
      const op=document.createElement('option'); op.value=p.name; op.textContent=p.name;
      if(selectedBooking && p.name===selectedBooking.staffName) op.selected=true;
      staff.appendChild(op);
    }
  });
  const sel=svc.options[svc.selectedIndex];
  const dur=sel?Number(sel.dataset.duration||0):0;
  svcDur.textContent=dur?`Duración: ${dur} min`:'Duración: —';
  buildTimeOptions(); updateNewSummary();
}
svc.addEventListener('change', ()=>{
  const biz=getBusinesses().find(x=>(x.slug||'')===(selectedBooking.businessSlug||'')); if(!biz) return;
  updateStaffOptions(biz, String(svc.value));
});
[staff,dateEl].forEach(el=>{
  el.addEventListener('change', ()=>{ buildTimeOptions(); updateNewSummary(); });
  el.addEventListener('input',  ()=>{ buildTimeOptions(); updateNewSummary(); });
});
timeSel.addEventListener('change', updateNewSummary);

function updateNewSummary(){
  if(!selectedBooking){ newSummary.value=''; return; }
  const sel=svc.options[svc.selectedIndex];
  const svcName=sel?sel.textContent.replace(/\s*\(\d+ min\)\s*$/,''):selectedBooking.serviceName;
  const dur=sel?Number(sel.dataset.duration||selectedBooking.durationMins):selectedBooking.durationMins;
  const stf=staff.value||selectedBooking.staffName;
  const date=dateEl.value||selectedBooking.date;
  const start=timeSel.value||selectedBooking.start;
  const end=(start&&dur)?addMinutes(start,dur):selectedBooking.end;

  newSummary.value=
    `Asistente: ${selectedBooking.attendee}\n`+
    `Establecimiento: ${selectedBooking.businessName}\n`+
    `Servicio: ${svcName} (${dur} min)\n`+
    `Barbero: ${stf}\n`+
    `Fecha: ${date}\n`+
    `Hora: ${start||'--:--'} - ${end||'--:--'}`;
}
function buildTimeOptions(){
  timeSel.innerHTML='<option value="">— Selecciona fecha —</option>'; timeSel.disabled=true; timeHelp.textContent='';
  if(!selectedBooking) return;
  const dateISO=dateEl.value; const sel=svc.options[svc.selectedIndex];
  const dur=sel?Number(sel.dataset.duration||selectedBooking.durationMins):selectedBooking.durationMins;
  const stf=staff.value||selectedBooking.staffName;
  if(!dateISO || !stf) return;

  const block=getScheduleBlockFor(selectedBooking.businessSlug, stf, dateISO);
  if(!block){ timeHelp.textContent='Sin horario publicado para esa fecha.'; return; }

  const dayIdx=(new Date(dateISO+'T00:00:00')).getDay();
  const schedIdx=(dayIdx+6)%7;
  const schedDay=block.schedule && block.schedule[schedIdx];
  const wins=windowsFromDay(schedDay);
  if(!wins.length){ timeHelp.textContent='Día no laborable.'; return; }

  let slots=slotsFromWindows(wins,dur);
  slots=removeBookedSlots(slots, selectedBooking.businessSlug, stf, dateISO, dur, selectedBooking.id);
  if(!slots.length){ timeHelp.textContent='No hay horas disponibles para ese día.'; return; }

  timeSel.innerHTML='<option value="">— Selecciona una hora —</option>';
  slots.forEach(t=>{ const op=document.createElement('option'); op.value=t; op.textContent=t; timeSel.appendChild(op); });
  timeSel.disabled=false;
}

btnReagendar.addEventListener('click', ()=>{
  if(!selectedBooking){ alert('Selecciona una cita.'); return; }
  const op=svc.options[svc.selectedIndex]; if(!op){ alert('Selecciona el servicio.'); return; }
  const dur=Number(op.dataset.duration||0);
  const serviceId=svc.value;
  const serviceName=op.textContent.replace(/\s*\(\d+ min\)\s*$/,'');
  const stf=staff.value; const date=dateEl.value; const start=timeSel.value;
  if(!stf){ alert('Selecciona el barbero.'); return; }
  if(!date){ alert('Selecciona la fecha.'); return; }
  if(!start){ alert('Selecciona la hora.'); return; }
  const end=addMinutes(start,dur);

  // evitar choques (excluye la propia)
  const same=getBookings().filter(b=> b.id!==selectedBooking.id && b.businessSlug===selectedBooking.businessSlug && b.staffName===stf && b.date===date);
  if(same.some(b=> overlap(start,end,b.start,b.end))){ alert('Esa franja no está disponible.'); return; }
  if(!confirm('¿Confirmas re-agendar la cita?')) return;

  // actualiza booking
  const all=getBookings();
  const i=all.findIndex(b=>b.id===selectedBooking.id);
  if(i>-1){
    all[i]={ ...all[i], serviceId, serviceName, durationMins:dur, staffName:stf, date, start, end };
    saveBookings(all);
  }
  // actualiza métricas
  const appts=getAppts();
  const j=appts.findIndex(a=>a.id===selectedBooking.id);
  if(j>-1){
    appts[j]={ ...appts[j], staffName:stf, serviceName, date, timeStart:start, timeEnd:end, status:'scheduled', updatedAt:new Date().toISOString() };
    saveAppts(appts);
  }
  alert('Cita re-agendada con éxito.');
  resetAll();
});
btnClear2.addEventListener('click', resetAll);
</script>

</body>
</html>
